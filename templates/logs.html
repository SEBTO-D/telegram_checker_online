{% extends "base.html" %}
{% block title %}@{{ user.username }} · История{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-sm mb-3"><i class="bi bi-arrow-left"></i> Назад</a>
    <h1 class="h4 fw-semibold mb-1">История статусов @{{ user.username }}</h1>
    <p class="text-white-50 mb-0">Часовой пояс: {{ timezone_name }}</p>
  </div>
  <a class="btn btn-primary" href="{{ url_for('export') }}"><i class="bi bi-download"></i> Экспорт CSV</a>
</div>

<div class="card bg-dark bg-opacity-25 border-0 shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3"><i class="bi bi-graph-up-arrow me-2"></i>Онлайн-активность</h5>
    <canvas id="statusChart" height="140"></canvas>
  </div>
</div>

<div class="card bg-dark bg-opacity-25 border-0 shadow-sm">
  <div class="card-body">
    <h5 class="card-title mb-3"><i class="bi bi-list-check me-2"></i>Последние события</h5>
    <div class="table-responsive">
      <table class="table table-dark-glass table-striped align-middle mb-0">
        <thead>
          <tr>
            <th>#</th>
            <th>Время</th>
            <th>Статус</th>
            <th>Последний онлайн</th>
          </tr>
        </thead>
        <tbody>
          {% for item in logs %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ item.ts }}</td>
              <td>
                {% if item.code == 'online' %}
                  <span class="badge bg-success">{{ item.status }}</span>
                {% elif item.code == 'offline' %}
                  <span class="badge bg-danger">{{ item.status }}</span>
                {% elif item.code in ['recently','last_week','last_month'] %}
                  <span class="badge bg-warning text-dark">{{ item.status }}</span>
                {% elif item.code == 'error' %}
                  <span class="badge bg-danger">{{ item.status }}</span>
                {% else %}
                  <span class="badge bg-secondary">{{ item.status }}</span>
                {% endif %}
              </td>
              <td>{{ item.last_seen }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script>
  const chartSource = {{ chart_data | safe }};
  const ctx = document.getElementById('statusChart');
  if (chartSource && ctx) {
    const palette = {
      line: 'rgba(76, 175, 80, 0.8)',
      background: 'rgba(76, 175, 80, 0.15)'
    };
    new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          label: chartSource.label,
          data: chartSource.data,
          borderColor: palette.line,
          backgroundColor: palette.background,
          parsing: { xAxisKey: 'x', yAxisKey: 'y' },
          fill: true,
          stepped: true,
          tension: 0,
          pointRadius: 3,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'time',
            time: { tooltipFormat: 'dd.MM.yyyy HH:mm' },
            ticks: { color: '#ced4da' },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: {
            min: 0,
            max: 1,
            ticks: {
              callback: value => value === 1 ? 'Онлайн' : 'Оффлайн',
              stepSize: 1,
              color: '#ced4da'
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        },
        plugins: {
          legend: { labels: { color: '#f8f9fa' } },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.raw.status}`
            }
          }
        }
      }
    });
  }
</script>
{% endblock %}
